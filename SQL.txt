CREATE DATABASE TTPetShop
go
USE TTPetShop
go

CREATE TABLE review (
	id INT PRIMARY KEY IDENTITY,
	productID INT REFERENCES dbo.Products(productID),
	userID varchar(20) REFERENCES dbo.Users(userID),
	rating FLOAT DEFAULT 0,
	review TEXT,
)
go
CREATE TABLE Products (
	productID INT PRIMARY KEY IDENTITY NOT NULL,
	name NVARCHAR(255) NOT NULL,
	price float NOT NULL DEFAULT '0',
	categoryID integer,
	description text,
	pic VARBINARY(MAX) ,
	quantity integer NOT NULL DEFAULT '1',
	viewed INTEGER DEFAULT 0

)
GO


SELECT * FROM dbo.Products
GO
---------------------------------------------------------------------------------------------
CREATE PROC updatePro @id INT, @name NVARCHAR(255), @price FLOAT, @categoryID INTEGER, @description TEXT, @pic VARBINARY(MAX), @quantity INTEGER, @viewed INTEGER
AS
BEGIN
	IF (DATALENGTH(@pic)!=0)
	BEGIN
		UPDATE dbo.Products SET name=@name, price=@price, categoryID=@categoryID, description=@description, pic=@pic, quantity=@quantity, viewed=@viewed WHERE productID=@id
	END
	ELSE
	BEGIN
		UPDATE dbo.Products SET name=@name, price=@price, categoryID=@categoryID, description=@description, quantity=@quantity, viewed=@viewed WHERE productID=@id
	END
END
go

CREATE PROC getProByID @id INT
AS
BEGIN
    SELECT *
	FROM dbo.Products WHERE productID=@id
END
go
-------------------------------------------------------------------------------------------------
CREATE TABLE Users(
	userID varchar(20) PRIMARY KEY NOT NULL,
	password varchar(20) NOT NULL,
	fullname NVARCHAR(255) NOT NULL,
	address VARCHAR(255),
	phone varchar(50),
	coins integer NOT NULL DEFAULT 0,
	role integer NOT NULL DEFAULT 0
)
GO

SELECT * from (SELECT ROW_NUMBER() OVER (ORDER BY coins) AS r, *FROM dbo.Users) AS sub  WHERE sub.r between 0*3+1 AND 1*3
go


INSERT INTO dbo.Users
(
    userID,
    password,
    fullname,
    address,
    phone,
    role
)
VALUES
(   'thanh141121',   -- userID - varchar(20)
    '141121',   -- password - varchar(20)
    N'Thanh Trung Trần',  -- fullname - nvarchar(255)
    'dong nai',   -- address - varchar
    '0338989824',   -- phone - varchar
    1  -- role - integer
    );

INSERT INTO dbo.Users
(
    userID,
    password,
    fullname,
    address,
    phone,
    role
)
VALUES
(   'thanh1411',   -- userID - varchar(20)
    '141121',   -- password - varchar(20)
    N'Thanh Trung Trần',  -- fullname - nvarchar(255)
    'dong nai',   -- address - varchar
    '0338989824',   -- phone - varchar
    0  -- role - integer
    );

INSERT INTO dbo.Users
(
    userID,
    password,
    fullname,
    address,
    phone,
    role
)
VALUES
(   'tam1111',   -- userID - varchar(20)
    '141121',   -- password - varchar(20)
    N'Pham Qui Tâm',  -- fullname - nvarchar(255)
    'dong nai',   -- address - varchar
    '0338989824',   -- phone - varchar
    0  -- role - integer
    );

INSERT INTO dbo.Users
(
    userID,
    password,
    fullname,
    address,
    phone,
    role
)
VALUES
(   'thanhtam',   -- userID - varchar(20)
    '141121',   -- password - varchar(20)
    N'Phạm Thành tâm',  -- fullname - nvarchar(255)
    'dong nai',   -- address - varchar
    '0338989824',   -- phone - varchar
    0  -- role - integer
    );

INSERT INTO dbo.Users
(
    userID,
    password,
    fullname,
    address,
    phone,
    role
)
VALUES
(   'tamthanh',   -- userID - varchar(20)
    '141121',   -- password - varchar(20)
    N'Trần Qui Thành',  -- fullname - nvarchar(255)
    'dong nai',   -- address - varchar
    '0338989824',   -- phone - varchar
    0  -- role - integer
    );


SELECT * FROM dbo.Users
go
CREATE TABLE Cart (
	cartID INT PRIMARY KEY IDENTITY,
	userID VARCHAR(20) NOT NULL REFERENCES Users(userID),
	total FLOAT DEFAULT 0
)
GO
CREATE TABLE DetailCart (
	cartID integer PRIMARY KEY,
	productID integer NOT NULL,
	quantity integer NOT NULL DEFAULT 1,
	FOREIGN KEY(cartID) REFERENCES Cart(cartID)
)
GO
CREATE TABLE Discount (
	discountID varchar PRIMARY KEY,
	quantity integer NOT NULL DEFAULT '1',
	desDiscount varchar NOT NULL,

)
GO
CREATE TABLE Bill (
	billID integer PRIMARY KEY IDENTITY,
	userID VARCHAR(20) NOT NULL REFERENCES Users(userID),
	total float NOT NULL DEFAULT 0,
	discountID VARCHAR REFERENCES Discount(discountID),
	date datetime DEFAULT getdate(),
	status integer NOT NULL DEFAULT '0'
)
GO
CREATE TABLE DetailBill (
	billID integer NOT NULL REFERENCES Bill(billID),
	productID integer NOT NULL REFERENCES Products(productID) ,
	quantity integer NOT NULL DEFAULT 1
)
GO
CREATE TABLE Category (
	categoryID integer PRIMARY KEY ,
	nameCat Nvarchar(255)

)
GO
INSERT INTO dbo.Category
(
    categoryID,
    nameCat
)
VALUES
(   1, -- categoryID - int
    N'Chuồng cho thú cưng' -- nameCat - varchar(255)
    )

INSERT INTO dbo.Category
(
    categoryID,
    nameCat
)
VALUES
(   2, -- categoryID - int
    N'Đồ chơi cho thú cưng' -- nameCat - varchar(255)
    )
INSERT INTO dbo.Category
(
    categoryID,
    nameCat
)
VALUES
(   3, -- categoryID - int
    N'Phụ kiện cho thú cưng' -- nameCat - varchar(255)
    )

INSERT INTO dbo.Category
(
    categoryID,
    nameCat
)
VALUES
(   4, -- categoryID - int
    N'Thức ăn cho thú cưng' -- nameCat - varchar(255)
    )

INSERT INTO dbo.Category
(
    categoryID,
    nameCat
)
VALUES
(   5, -- categoryID - int
    N'Thuốc cho thú cưng' -- nameCat - varchar(255)
    )

INSERT INTO dbo.Category
(
    categoryID,
    nameCat
)
VALUES
(   6, -- categoryID - int
    N'Thời trang cho thú cưng' -- nameCat - varchar(255)
    )

INSERT INTO dbo.Category
(
    categoryID,
    nameCat
)
VALUES
(   7, -- categoryID - int
    N'Dịch vụ khác...' -- nameCat - varchar(255)
    )

go
------------------------------------------------------
ALTER TABLE Products WITH CHECK ADD CONSTRAINT Products_fk0 FOREIGN KEY (categoryID) REFERENCES Category(categoryID)
go


ALTER TABLE DetailCart WITH CHECK ADD CONSTRAINT DetailCart_fk1 FOREIGN KEY (productID) REFERENCES Products(productID)
go

SELECT * FROM dbo.Bill
go

-----------------------------------------------------------store proc-------------------------------------------------------
